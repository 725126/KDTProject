<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{layout/basic/in-home.html}">
<head>
    <meta charset="UTF-8">
    <title>ìì¬ON - ì…ê³  > ê±°ë˜ ëª…ì„¸</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <link rel="stylesheet" th:href="@{/css/component/tooltip-custom.css}">
    <link rel="stylesheet" th:href="@{/css/component/search-input.css}">
</head>
<body>

<th:block layout:fragment="incoming-trans">
    <!-- ë¸Œë ˆë“œí¬ëŸ¼ start -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb px-3 py-2 rounded">
            <li class="breadcrumb-item">
                <a href="/internal/home" class="text-decoration-none text-dark">
                    <i class="bi bi-house-door me-1"></i> í™ˆ
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="#" class="text-decoration-none text-dark">
                    <i class="bi bi-box-arrow-in-down me-1"></i> ì…ê³ 
                </a>
            </li>
            <li class="breadcrumb-item active text-primary" aria-current="page">
                ê±°ë˜ ëª…ì„¸ ë°œí–‰
            </li>
        </ol>
    </nav>
    <!-- ë¸Œë ˆë“œí¬ëŸ¼ end -->

    <div class="container-xl mt-5">
        <!-- ê±°ë˜ ëª…ì„¸ì„œ ë°œí–‰ í…Œì´ë¸” + í•„í„° UI í†µí•© -->
        <!-- ê²€ìƒ‰ + í•„í„° ì˜ì—­ -->
        <div class="d-flex justify-content-between mb-3">
            <div class="position-relative w-25">
                <div id="toastAlert" class="toast align-items-center text-bg-warning border-0 position-absolute top-0 start-0 z-3"
                     role="alert" aria-live="assertive" aria-atomic="true" style="z-index: 9999;">
                    <div class="d-flex">
                        <div class="toast-body">
                            ğŸ“Œ ê²€ìƒ‰ ê¸°ì¤€ì„ ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto"
                                data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
                <i class="bi bi-search search-icon"></i>
                <input type="text" id="searchInput" class="form-control search-input" placeholder="ê²€ìƒ‰"
                       data-bs-toggle="dropdown" aria-expanded="false" th:value="${keyword}">
                <ul class="dropdown-menu" id="dropdownMenu" title="ê²€ìƒ‰ ëŒ€ìƒ ì„ íƒ" data-bs-toggle="tooltip" data-bs-placement="bottom">
                    <li>
                        <label class="checkbox-toss">
                            <input type="checkbox" id="allCheck" onchange="toggleAll(this)">
                            <span>(ëª¨ë‘ ì„ íƒ)</span>
                        </label>
                    </li>
                    <li>
                        <label class="checkbox-toss">
                            <input type="checkbox" id="orderId"
                                   th:checked="${selectedCategory != null and selectedCategory.contains('orderId')}">
                            <span>ë°œì£¼ì½”ë“œ</span>
                        </label>
                    </li>
                    <li>
                        <label class="checkbox-toss">
                            <input type="checkbox" id="pCompany"
                                   th:checked="${selectedCategory != null and selectedCategory.contains('pCompany')}">
                            <span>í˜‘ë ¥ì—…ì²´</span>
                        </label>
                    </li>
                    <li>
                        <label class="checkbox-toss">
                            <input type="checkbox" id="matId"
                                   th:checked="${selectedCategory != null and selectedCategory.contains('matId')}">
                            <span>ìì¬ì½”ë“œ</span>
                        </label>
                    </li>
                    <li>
                        <label class="checkbox-toss">
                            <input type="checkbox" id="matName"
                                   th:checked="${selectedCategory != null and selectedCategory.contains('matName')}">
                            <span>ìì¬ëª…</span>
                        </label>
                    </li>
                    <li>
                        <label class="checkbox-toss">
                            <input type="checkbox" id="titemQty"
                                   th:checked="${selectedCategory != null and selectedCategory.contains('titemQty')}">
                            <span>ë‚©ì…ëŸ‰</span>
                        </label>
                    </li>
                    <li>
                        <label class="checkbox-toss">
                            <input type="checkbox" id="titemPrice"
                                   th:checked="${selectedCategory != null and selectedCategory.contains('titemPrice')}">
                            <span>ë‹¨ê°€</span>
                        </label>
                    </li>
                    <li>
                        <label class="checkbox-toss">
                            <input type="checkbox" id="amount"
                                   th:checked="${selectedCategory != null and selectedCategory.contains('amount')}">
                            <span>ì´ ê¸ˆì•¡</span>
                        </label>
                    </li>
                    <li>
                        <label class="checkbox-toss">
                            <input type="checkbox" id="incomingLastCompletedAt"
                                   th:checked="${selectedCategory != null and selectedCategory.contains('incomingLastCompletedAt')}">
                            <span>ë‚ ì§œ</span>
                        </label>
                    </li>
                </ul>
            </div>


            <div class="d-flex gap-2 align-items-center">
                <i class="bi bi-funnel text-secondary" title="ì •ë ¬ í•„í„°"></i>
                <select class="form-select form-select w-auto" name="sort" id="sortSelect">
                    <option value="newest" th:selected="${selectedSort == 'newest'}">ìµœì‹  ìˆœ</option>
                    <option value="oldest" th:selected="${selectedSort == 'oldest'}">ì˜¤ë˜ëœ ìˆœ</option>
                    <option value="companyAsc" th:selected="${selectedSort == 'matIdAsc'}">ë°œì£¼ ì½”ë“œ ìˆœ</option>
                    <option value="materialAsc" th:selected="${selectedSort == 'totalAmountDes'}">ì´ ê¸ˆì•¡ ë†’ì€ ìˆœ</option>
                </select>
                <button class="btn btn-primary ms-2" id="generateStatementBtn">
                    <i class="bi bi-file-earmark-text me-1"></i> ê±°ë˜ëª…ì„¸ì„œ ë°œí–‰
                </button>
            </div>

        </div>

        <!-- í…Œì´ë¸” -->
        <div class="table-responsive rounded border table-scroll">
            <table class="table table-hover text-center align-middle mb-0">
                <thead class="table-light text-dark border-bottom">
                <tr>
                    <th scope="col"><input type="checkbox" id="selectAll"></th>
                    <th scope="col">ë°œì£¼ì½”ë“œ</th>
                    <th scope="col">í˜‘ë ¥ì—…ì²´</th>
                    <th scope="col">ìì¬ì½”ë“œ</th>
                    <th scope="col">ìì¬ëª…</th>
                    <th scope="col">ë‚©ì…ëŸ‰</th>
                    <th scope="col">ë‹¨ê°€(ì›)</th>
                    <th scope="col">ì´ ê¸ˆì•¡(ì›)</th>
                    <th scope="col">ë‚ ì§œ</th>
                </tr>
                </thead>
                <tbody class="table-group-divider">
                <tr th:each="Transation : ${TransationList}">
                    <td><input type="checkbox" name="selectedRows"
                               th:attr="data-partner-id=${Transation.partnerId}"
                               th:value="${Transation.orderId}"></td>
                    <td th:text="${Transation.orderId}"></td>
                    <td th:text="${Transation.pCompany}"></td>
                    <td th:text="${Transation.matId}"></td>
                    <td th:text="${Transation.matName}"></td>
                    <td th:text="${Transation.titemQty}"></td>
                    <td th:text="${Transation.titemPrice}"></td>
                    <td th:text="${Transation.amount}"></td>
                    <td th:text="${Transation.incomingLastCompletedAt}"></td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- ê±°ë˜ëª…ì„¸ì„œ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
        <div class="modal fade" id="transactionPreviewModal" tabindex="-1"
             aria-labelledby="transactionPreviewModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="transactionPreviewModalLabel">ê±°ë˜ëª…ì„¸ì„œ ë¯¸ë¦¬ë³´ê¸°</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
                    </div>
                    <div class="modal-body" id="previewModalBody">
                        <!-- JSë¡œ ë¯¸ë¦¬ë³´ê¸° ë‚´ìš© ì‚½ì…ë¨ -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                        <button type="button" class="btn btn-success" id="confirmIssueBtn">
                            <i class="bi bi-check-circle"></i> ê±°ë˜ëª…ì„¸ì„œ ë°œí–‰
                        </button>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <script>
        document.getElementById("selectAll").addEventListener("change", function () {
            const checkboxes = document.querySelectorAll("input[name='selectedRows']");
            checkboxes.forEach(cb => cb.checked = this.checked);
        });

        document.getElementById("generateStatementBtn").addEventListener("click", () => {
            const checkedRows = Array.from(document.querySelectorAll("input[name='selectedRows']:checked"));
            if (checkedRows.length === 0) {
                alert("ğŸ“Œ ìµœì†Œ í•œ ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            const groupedData = {};

            checkedRows.forEach(cb => {
                const row = cb.closest("tr");
                const partnerId = cb.getAttribute("data-partner-id");
                const orderId = row.children[1].textContent;
                const company = row.children[2].textContent;
                const matId = row.children[3].textContent;
                const matName = row.children[4].textContent;
                const qty = row.children[5].textContent;
                const price = row.children[6].textContent;
                const amount = row.children[7].textContent;
                const date = row.children[8].textContent;

                if (!groupedData[partnerId]) {
                    groupedData[partnerId] = {
                        company,
                        rows: []
                    };
                }

                groupedData[partnerId].rows.push({orderId, matId, matName, qty, price, amount, date});
            });

            let html = '';

            for (const partnerId in groupedData) {
                const group = groupedData[partnerId];
                html += `
          <h6 class="fw-bold mb-2 mt-4"><i class="bi bi-building"></i> ${group.company}</h6>
          <div class="table-responsive">
            <table class="table table-bordered table-hover text-center align-middle mb-4">
              <thead class="table-light">
                <tr>
                  <th>ë°œì£¼ì½”ë“œ</th>
                  <th>ìì¬ì½”ë“œ</th>
                  <th>ìì¬ëª…</th>
                  <th>ë‚©ì…ëŸ‰</th>
                  <th>ë‹¨ê°€(ì›)</th>
                  <th>ì´ ê¸ˆì•¡(ì›)</th>
                  <th>ë‚ ì§œ</th>
                </tr>
              </thead>
              <tbody>
        `;

                group.rows.forEach(item => {
                    html += `
              <tr>
                <td>${item.orderId}</td>
                <td>${item.matId}</td>
                <td>${item.matName}</td>
                <td>${item.qty}</td>
                <td>${item.price}</td>
                <td>${item.amount}</td>
                <td>${item.date}</td>
              </tr>
            `;
                });

                html += `</tbody></table></div>`;
            }

            document.getElementById("previewModalBody").innerHTML = html;
            new bootstrap.Modal(document.getElementById("transactionPreviewModal")).show();
        });

        document.getElementById("confirmIssueBtn").onclick = () => {
            const checkedRows = Array.from(document.querySelectorAll("input[name='selectedRows']:checked"));
            if (checkedRows.length === 0) {
                alert("ğŸ“Œ ìµœì†Œ í•œ ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            const partnerMap = {};

            checkedRows.forEach(cb => {
                const row = cb.closest("tr");
                const partnerId = cb.getAttribute("data-partner-id");
                const orderId = cb.value;

                const matId = row.children[3].textContent;
                const qty = parseInt(row.children[5].textContent.replace(/,/g, "")) || 0;
                const price = parseInt(row.children[6].textContent.replace(/,/g, "")) || 0;

                if (!partnerMap[partnerId]) {
                    partnerMap[partnerId] = [];
                }

                partnerMap[partnerId].push({
                    orderId: orderId,
                    matId: matId,
                    qty: qty,
                    price: price
                });
            });

            // ìµœì¢… payload êµ¬ì„±
            const partnerTransactions = Object.entries(partnerMap).map(([partnerId, items]) => ({
                partnerId: parseInt(partnerId),
                items: items
            }));

            console.log(JSON.stringify({partnerTransactions: partnerTransactions}, null, 2));

            fetch("/internal/transaction/statement", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRF-TOKEN": document.querySelector('meta[name="_csrf"]').getAttribute("content")
                },
                body: JSON.stringify({partnerTransactions: partnerTransactions})
            })
                .then(res => {
                    if (res.ok) {
                        alert("âœ… ê±°ë˜ëª…ì„¸ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        window.location.reload();
                    } else {
                        throw new Error("ì„œë²„ ì˜¤ë¥˜");
                    }
                })
                .catch(err => {
                    alert("âŒ ê±°ë˜ëª…ì„¸ì„œ ë°œí–‰ ì‹¤íŒ¨: " + err.message);
                });
        };
    </script>

    <script th:src="@{/js/util/tooltip-custom.js}"></script>
    <script>
        function toggleAll(source) {
            const checkboxes = document.querySelectorAll("#dropdownMenu input[type='checkbox']");
            checkboxes.forEach(cb => {
                if (cb !== source) cb.checked = source.checked;
            });
        }

        function applyInternalTransFilter() {
            const keyword = document.getElementById("searchInput").value.trim();
            const sort = document.getElementById("sortSelect").value;

            // ì²´í¬ëœ ê²€ìƒ‰ ê¸°ì¤€ ì¶”ì¶œ
            const selectedCategory = Array.from(document.querySelectorAll("#dropdownMenu input[type='checkbox']:checked"))
                .filter(cb => cb.id !== 'allCheck')
                .map(cb => cb.id);

            // âœ… ì²´í¬ë°•ìŠ¤ ì„ íƒ ì•ˆ ëœ ê²½ìš° â†’ í† ìŠ¤íŠ¸ ì•Œë¦¼
            if (selectedCategory.length === 0) {
                const toast = new bootstrap.Toast(document.getElementById('toastAlert'));
                toast.show();
                return; // ê²€ìƒ‰ ì‹¤í–‰ ì¤‘ë‹¨
            }

            let url = `/internal/incoming/trans?`;

            if (keyword) url += `keyword=${encodeURIComponent(keyword)}&`;
            if (selectedCategory.length > 0) {
                selectedCategory.forEach(cat => url += `category=${cat}&`);
            }
            url += `sort=${sort}`;

            location.href = url;
        }

        // Enter í‚¤ ê²€ìƒ‰
        document.getElementById("searchInput").addEventListener("keypress", e => {
            if (e.key === "Enter") applyInternalTransFilter();
        });

        // ì •ë ¬ ë³€ê²½ ì‹œ
        document.getElementById("sortSelect").addEventListener("change", applyInternalTransFilter);
    </script>
</th:block>


</body>
</html>